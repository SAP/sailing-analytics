# Tracking App API v1 Draft

## General

This is a design for the REST API to be used by the iOS and Android tracking apps.

## Push Notifications

Event data can be updated via push notifications. These are limited on iOS to 256 bytes (not characters). For this reason, on receiving a push notification, the app must GET the event data.

## Checkin Information

### Path

   http://kielerwoche2015.sapsailing.com:8888/api/v1/checkin_info.json?leaderboard={unique_leaderboard_name}&competitor_id={competitor_id}

### Verb

    GET

### Response

    {
        "serverUrl" : "http://kielerwoche2015.sapsailing.com:8888",
        "event" : {
            "id" : "957fab64e36d240dd07aeed2bd5a84b6",
            "title" : "Kieler Woche",
            "startDate" : 1414414481000,
            "endDate" : 1414609200000
        },
        "regatta": {
            "id": "237fab64e36d240dd07aeed2bd5a8426",
            "title": "49ers"
        },
        "competitor":{
             "id" : "e45fab64e36d240dd07aeed2bd5a8a21",
             "name" : "Alster Segel Club",
             "registration" : "GER 13"
        }
    }

**serverUrl** This is the endpoint to be used for all following REST requests.

## Check-In

After the user has received the event data with the short URL, the smartphone is mapped to a competitor.

_Question: What should be done if a second device is mapped to competitor?_

### Path

    {serverUrl}/api/v1/leaderboard/{unique_leaderboard_name}/competitor/{competitor_id}/checkin.json

### Verb

    POST

### Request

    {
        "deviceUdid" : "202cb962ac59075b964b07152d234b70",
        "deviceType" : "ios",
        "pushDeviceId" : "0f744707bebcf74f9b7c25d48e3358945f6aa01da5ddb387462c7eaf61bbad78"
    }

**deviceUdid** A UDID generated by device, generated on first run.

**deviceType** Either `android` or `ios`. Needed for selecting correct push notification service.

**pushDeviceId** On Android the GCM regId, on iOS the APNS push token. This is needed for sending push notifications to the device.

## Checkout

Needed to destroy a device coupling with leaderboard & competitor. AKA checkout.

### Path

    {serverUrl}/api/v1/leaderboard/{unique_leaderboard_name}/competitor/{competitor_id}/device/{deviceUdid}.json

### Verb
 
    DELETE


## Regatta Info

Informations regarding a regatta. We need the list of (scheduled) races to remind the user to start tracking.

### Path

    {serverUrl}/api/v1/leaderboard/{unique_leaderboard_name}/regatta.json

or
  
    {serverUrl}/api/v1/event/{event_id}/regatta/{regatta_id}.json

### Verb

    GET

### Response

    {
      "id": "237fab64e36d240dd07aeed2bd5a8426",
      "title": "49ers",
      "event_id" : "237fab64e36d240dd07aeed2bd5a8426"
      "leaderboard" : "Leaderboard Identifier",
      "races":[
        {
          "startTime" : 1414414481000,
          "status" : "finished",
          "fleet" : "Blue"
          "phase" : "Qualification"
          "name" : "Q1"
        },
        {
          "startTime" : 1414414481005,
          "status" : "running",
          "fleet" : "Red"
          "phase" : "Qualification"
          "name" : "Q1"
        },
        {
          "startTime" : 1414414481010,
          "status" : "scheduled",
          "fleet" : "Blue"
          "phase" : "Qualification"
          "name" : "Q2"
        },
        {
          "startTime" : "",
          "status" : "unscheduled",
          "fleet" : "Red"
          "phase" : "Qualification"
          "name" : "Q2"
        }
       ]
    },


## Competitor Info

Informations for a competitor can be requested.

### Path

    {serverUrl}/api/v1/competitor/{competitor_id}.json

### Verb

    GET

### Response

    {
     "Id" : "250cf8b51c773f3f8dc8b4be867a9a02",
     "Name" : "Alster Segel Club",
     "ProfileImageUrl" : "http://s3.amazonaws.com/sapsailing/profile_images/68053af2923e00204c3ca7c6a3150cf7.jpeg"
     "Flag": {BASE64STRING or URL},
     "Registration": "GER 14"
    }

## Upload Profile Image

An image can be uploaded per competitor.

### Path

    {serverUrl}/api/v1/competitor/{competitor_id}/profile_image.json

### Verb

    POST

### Request

Multipart upload with part `image` containing JPEG image 80%, max dimension 1200px.

### Response

    {
        "profileImageUrl" : "http://s3.amazonaws.com/sapsailing/profile_images/68053af2923e00204c3ca7c6a3150cf7.jpeg"
    }

**profileImageUrl** URL of uploaded image.

## Send Measurements (to the Fix Store)

The main data sent by the app.

Measurements should be sent live during an event. In case of missing network, measurements are stored to the device and uploaded in a FIFO order as soon as a connection is available.

GZIP compression is a must. Bulk uploads should be chunked, e.g. per 1,000 locations.

### Path

    {serverUrl}/api/v1/fix_store.json

### Verb

    POST

### Request

    {
        "measurements" : [
            {
                "timestamp" : 14144160080000,
                "latitude" : 54.325246,
                "longitude" : 10.148556,
                "speed" : 3.61,
                "course" : 258.11,
            },
            {
                "timestamp" : 14144168490000,
                "latitude" : 55.12456,
                "longitude" : 8.03456,
                "speed" : 5.1,
                "course" : 14.2,
            },
            ...
        ]
    }

**speed** Speed over ground in meters per second.

**course** Heading in degrees.
