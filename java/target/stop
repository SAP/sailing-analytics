#!/bin/bash

. `pwd`/env.sh

TELNET_ACTIVE=`netstat -tlnp 2>/dev/null | grep ":$TELNET_PORT"`
if [[ $TELNET_PORT == "" ]] || [[ $TELNET_ACTIVE == "" ]]; then
        echo "Could not find server on telnet port $TELNET_PORT. Perhaps server is not running?"
        if [[ $SERVER_STARTUP_NOTIFY != "" ]]; then
            echo "Stopped" | `which mail` -s "Server $SERVER_NAME could not be stopped!" $SERVER_STARTUP_NOTIFY
        fi
        exit
fi

NC_CMD="nc -t 127.0.0.1 $TELNET_PORT"
echo -n exit | $NC_CMD > /dev/null

# make really sure to kill server
kill `cat server.pid`
sleep 5
rm server.pid

echo "Stopped server $SERVER_NAME"
if [[ $SERVER_STARTUP_NOTIFY != "" ]]; then
    echo "OK" | `which mail` -s "Server $SERVER_NAME stopped successfully!" $SERVER_STARTUP_NOTIFY
fi
