#!/bin/bash

# source variables
. `pwd`/env.sh

echo "Configuration for this server is:"
echo ""
echo "SERVER_NAME: $SERVER_NAME"
echo "MEMORY: $MEMORY"
echo "SERVER_PORT: $SERVER_PORT"
echo "TELNET_PORT: $TELNET_PORT"
echo "MONGODB_HOST: $MONGODB_HOST"
echo "MONGODB_PORT: $MONGODB_PORT"
echo "MONGODB_NAME: $MONGODB_NAME"
echo "EXPEDITION_PORT: $EXPEDITION_PORT"
echo "REPLICATION_HOST: $REPLICATION_HOST"
echo "REPLICATION_CHANNEL: $REPLICATION_CHANNEL"
echo "ADDITIONAL_ARGS: $ADDITIONAL_JAVA_ARGS"
echo ""
echo "INSTALL_FROM_RELEASE: $INSTALL_FROM_RELEASE"
echo "DEPLOY_TO: $DEPLOY_TO"
echo "BUILD_BEFORE_START: $BUILD_BEFORE_START"
echo "USE_ENVRIONMENT: $USE_ENVIRONMENT"
echo ""
echo "JAVA_HOME: $JAVA_HOME"
echo "INSTANCE_ID: $INSTANCE_ID"
echo ""

RACING_EVENT_SERVICE_AVAILABLE=$(curl http://127.0.0.1:$SERVER_PORT/sailingserver/api/v1/status 2>/dev/null | jq .available)
REPLICATION_AVAILABLE=$(curl http://127.0.0.1:$SERVER_PORT/replication/replication?action=STATUS 2>/dev/null | jq .available)
INDEX_HTML_STATUS=$(curl -I http://127.0.0.1:8888/index.html 2>/dev/null | head -n 1 | cut -d ' ' -f 2)

echo "RACING_EVENT_SERVICE_AVAILABLE: $RACING_EVENT_SERVICE_AVAILABLE"
echo "REPLICATION_AVAILABLE: $REPLICATION_AVAILABLE"
echo "INDEX_HTML_STATUS: $INDEX_HTML_STATUS"

if [[ $RACING_EVENT_SERVICE_AVAILABLE == "true" && $REPLICATION_AVAILABLE == "true" && $INDEX_HTML_STATUS =~ 2.. ]]; then
    echo "Server $SERVER_NAME is available on $SERVER_PORT"
    exit 0
else
    echo "Server $SERVER_NAME is not available."
    exit 1
fi

