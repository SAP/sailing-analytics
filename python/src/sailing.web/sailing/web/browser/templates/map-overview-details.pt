
<div class="info">
    Selected Race: <b>${view.currentRace().name}</b>&nbsp;Started: <b>${view.millisToDatetime(view.currentRace().start)} (${view.currentRace().start})</b>&nbsp;Finish: <b>${view.millisToDatetime(view.currentRace().finish)} (${view.currentRace().finish})</b>&nbsp;Last Update: <b>${view.millisToDatetime(view.currentRace().timeofnewestevent)} (${view.currentRace().timeofnewestevent})</b><br/><br/>

    <div>
        Timepoint: <span id="wind-timepoint">...</span>&nbsp;
        Bearing: <span id="wind-bearing">...</span>&nbsp;
        Speed: <span id="wind-speed">...</span>&nbsp;
        Lat: <span id="wind-lat">...</span>&nbsp;
        Lng: <span id="wind-lng">...</span>&nbsp;
    </div>

    <form id="map-tracks-form" method="POST" action="/++/loadTracks">
        <div class="field">
            <span>Timepoint:</span>&nbsp;&nbsp;<input type="text" name="at" value="${view.millisToDatetime(view.currentRace().start).strftime('%m/%d/%Y %H:%M:%S')}" />&nbsp;
            <input style="width:50px;" type="button" value="Start" onclick="dateSet('${view.millisToDatetime(view.currentRace().start).strftime('%m/%d/%Y %H:%M:%S')}');"/>&nbsp;
            <input style="width:40px;" type="button" value="Now" onclick="dateSet('now');"/>&nbsp;
            <input style="width:50px;" type="button" value="End" onclick="dateSet('${view.millisToDatetime(view.currentRace().finish).strftime('%m/%d/%Y %H:%M:%S')}');"/>&nbsp;
            <input style="width:40px;" type="button" value="-5M" onclick="dateBackward(5*60);"/>&nbsp;
            <input style="width: 40px;" type="button" value="-1M" onclick="dateBackward(60);"/>&nbsp;
            <input style="width: 40px;" type="button" value="-10s" onclick="dateBackward(10)"/>&nbsp;
            <input type="button" style="width: 20px;" value="-" onclick="dateBackward($('#sec').attr('value'))"/>&nbsp;<input style="width: 30px;" type="text" id="sec"/>&nbsp;sec.&nbsp;<input type="button" style="width: 20px;" value="+" onclick="dateForward($('#sec').attr('value'))"/>&nbsp;
            <input style="width: 40px;" type="button" value="+10s" onclick="dateForward(10)"/>&nbsp;
            <input style="width:40px;" type="button" value="+1M" onclick="dateForward(60);"/>&nbsp;
            <input style="width: 40px;" type="button" value="+5M" onclick="dateForward(5*60);"/>&nbsp;
        </div>
    </form>


    <table width="100%">
        <tr>
            <td valign="top">
                <div id="map_wrapper" style="width: 968px; height: 768px;border: 1px solid black;margin: 10px 5px;">
                    &nbsp;
                </div>
            </td>
            <td valign="top">
                <div id="data_wrapper" style="width: 150px; height: 1680px;">
                    &nbsp;
                </div>
            </td>
        </tr>
    </table>

    <script>
        function loadCompetitorsData(at) {
            GET('mapCompetitors', {at: at}, function(data) {
                values = '';
                for (d in data) {
                    values += format('<div class="competitor"><a href="javascript:;" onclick="toggleMarker(\'{competitor}\')">{competitor}</a>&nbsp;<b>{rank}</b></div>', data[d]);
                }

                $('#data_wrapper').html(values);
            });
        }

        function loadWind(at) {
            racename = $('select[name=racename] option:selected').val();
            GET('readWind', {}, function(data) {
                $('#wind-timepoint').html(data.timepoint);
                $('#wind-bearing').html(data.truebearingdeg);
                $('#wind-speed').html(data.knotspeed);
                $('#wind-lat').html(data.latdeg);
                $('#wind-lng').html(data.lngdeg);
            });

            // also show wind directions
            GET('determineWindDirection', {at : at}, function(data) {
                map.clearPaths();
                if (typeof data == 'string') {
                    alert('Error: ' + data);
                    return;
                }

                for (d in data) {
                    obj = data[d];

                    if (obj.markLngDeg != undefined) {
                        map.addConnectedMarkers(obj.markLatDeg, obj.markLngDeg, obj.toLatDeg, obj.toLngDeg);
                    }
                }
            });
        }

        function dateSet(dt) {
            if (dt == 'now') {
                $('input[name=at]').datetimepicker('setDate', new Date());
            } else {
                $('input[name=at]').attr('value', dt);
            }
            $('#map-tracks-form').submit();
        }

        function dateForward(seconds) {
            elm = $('input[name=at]').datetimepicker('getDate');
            if (elm) {
                $('input[name=at]').datetimepicker('setDate', new Date(elm.valueOf()+(seconds*1000)));
                $('#map-tracks-form').submit();
            }
        }

        function dateBackward(seconds) {
            elm = $('input[name=at]').datetimepicker('getDate');
            if (elm) {
                $('input[name=at]').datetimepicker('setDate', new Date(elm.valueOf()-(seconds*1000)));
                $('#map-tracks-form').submit();
            }
        }

        $(document).ready(function() {

            initializeMap();
            showBuoys();

            $('input[name=at]').datetimepicker({timeFormat: 'hh:mm:ss', showDate: true});

            $('#map-tracks-form').submit(function() {
                displayLoader('#data_wrapper');
                $(this).ajaxSubmit({
                    success: function(data) {
                        map.clearMarkers();
                        showBuoys();

                        for (d in data) {
                            obj = data[d];

                            if (obj.latdeg != undefined) {
                                map.addMarker(obj.latdeg, obj.lngdeg, obj.name, _base_url() + 'static/images/boat16.png');
                            } else {
                            }
                        }

                        loadWind($('input[name=at]').attr('value'));
                        loadCompetitorsData($('input[name=at]').attr('value'));
                    }
                });
                return false;
            });

        });
    </script>
</div>
