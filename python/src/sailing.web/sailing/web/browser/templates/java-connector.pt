
<div class="help">These settings control how the Java server connects to TracTrac and which event is tracked. Use these settings with care!
When <i>stopping listener</i> it will trigger two methods: If you select a race it will call stoprace, if no race is selected it will call stopevent.</div>

<form method="POST" action="/++/configureListener">
    <tal:if condition="not view.listenerStarted()">

    <fieldset>
        <legend>1. Connection</legend>
        <div class="field">
            <span>Host and Port:</span><br/>
            <input type="text" id="serverhost" name="host"/>&nbsp;<input id="serverport" type="text" name="port"/>&nbsp;
            <select name="hostport" id="hostport" onchange="$('#serverhost').val($('#hostport option:selected').attr('host'));$('#serverport').val($('#hostport option:selected').attr('port'))">
                <option host="" port=""></option>
                <option host="dev.kielweek.web4sap.com" port="80" expedition="2010">DEV-EXTERN ${view.serverStatus('dev.kielweek.web4sap.com', '80')}</option>
                <option host="test.kielweek.web4sap.com" port="80" expedition="2011">TEST-EXTERN ${view.serverStatus('test.kielweek.web4sap.com', '80')}</option>
                <option host="prod1.kielweek.web4sap.com" port="80" expedition="2013">PROD1-EXTERN ${view.serverStatus('prod1.kielweek.web4sap.com', '80')}</option>
                <option host="prod2.kielweek.web4sap.com" port="80" expedition="2014">PROD2-EXTERN ${view.serverStatus('prod2.kielweek.web4sap.com', '80')}</option>
                <option host="localhost" port="8887" expedition="2011">TEST-INTERN ${view.serverStatus('localhost', '8887')}</option>
                <option host="localhost" port="8886" expedition="2010">DEV-INTERN ${view.serverStatus('localhost', '8886')}</option>
                <option host="localhost" port="8888" expedition="2013">PROD1-INTERN ${view.serverStatus('localhost', '8888')}</option>
                <option host="localhost" port="8889" expedition="2014">PROD2-INTERN ${view.serverStatus('localhost', '8889')}</option>
            </select>
        </div>

        <div class="field">
            <span>Use given delay (UTCnow() - n Minutes) for loading race data</span><br/>
            <input type="text" name="delay" value="" />
        </div>

        <input type="submit" name="listener-event-refresh" value="Connect to already running server" /><br/><br/>
    </fieldset>

    <fieldset>
        <legend>2. Event Configuration</legend>
        <div class="field">
            <span>URL to event configuration</span><br/>
            <input class="large" type="text" name="eventJSONURL" id="eventJSONURL" value=""/>

            <select name="eventJSONURLselect" onchange="$('input[name=eventJSONURL]').val($('select[name=eventJSONURLselect] option:selected').val())">
                <option value=""></option>
                <option value="http://germanmaster.traclive.dk/events/event_20110609_KielerWoch/jsonservice.php">Kiel Week</option>
                <option value="http://germanmaster.traclive.dk/events/event_20110505_SailingTea/jsonservice.php">STG Training</option>
            </select>
            <pre style="background-color: #ececec; font-size: 12px;padding: 2px;">
            <tal:for repeat="eventurl view.eventUrlHistory()"> ${eventurl}</tal:for></pre>
        </div>

        <input type="button" onclick="displayLoader('#race-loader');GET('loadRacesForEvent', {eventJSONURL: $('#eventJSONURL').val(), host: $('#serverhost').val(), port: $('#serverport').val()}, function(data) {$('#race-loader').html(data)});$('#extended-conf').show()" value="List Races"/>&nbsp;
        <input type="button" onclick="displayLoader('#race-loader');template('java-connector-custom-race', {}, function(data) {$('#race-loader').html(data)});$('#extended-conf').show();$('#eventJSONURL').val('');" value="Customized Race Configuration"/>
    </fieldset>

    <div id="extended-conf" style="display:none;">
    <fieldset>
        <legend>3. Race Configuration </legend>

        <div id="race-loader">&nbsp;</div>

            <div class="field">
                <span>Live-Connection (host:port):</span><br/>
                <input class="large" type="text" name="liveURI" value="" />
                <select name="liveURIselect" onchange="$('input[name=liveURI]').val($('select[name=liveURIselect] option:selected').val())">
                    <option value=""></option>
                    <option value="tcp://germanmaster.traclive.dk:1520">Kiel Week</option>
                    <option value="tcp://sapsimulation.tracdev.dk:4420">J80 Race 12</option>
                    <option value="tcp://germanmaster.traclive.dk:4400">STG Training</option>
                </select>
            </div>

            <div class="field">
                <span>Data-Connection (host:port):</span><br/>
                <input class="large" type="text" name="storedURI" value="" />
                <select name="storedURIselect" onchange="$('input[name=storedURI]').val($('select[name=storedURIselect] option:selected').val())">
                    <option value=""></option>
                    <option value="tcp://germanmaster.traclive.dk:1521">Kiel Week</option>
                    <option value="tcp://sapsimulation.tracdev.dk:4421">J80 Race 12</option>
                    <option value="tcp://germanmaster.traclive.dk:4401">STG Training</option>
                </select>
            </div>
    </fieldset>

    <fieldset>
            <legend>4. Admin Configuration</legend>

            <div class="field">
                <span>Store where to persist wind tracks</span><br/>
                <select name="windstore">
                    <option value="mongo">MongoDB Persister</option>
                    <option value="empty">Do not persist wind</option>
                </select>
            </div>

            <div class="field">
                <input type="checkbox" name="drop_db" />&nbsp;
                <span>Drop Database before connect (Dangerous!! Better use the selective DROP in DB tab)</span><br/>
            </div>

            <div class="field">
                <input type="checkbox" name="start_expedition" checked="checked" />&nbsp;
                <span>Start UDP expedition wind listener</span><br/>
                <input type="hidden" name="expedition_port" value=""/>
            </div>

            <input type="submit" name="listener-start" value="Connect to TracTrac"/>&nbsp;
    </fieldset>
    </div>
    </tal:if>

    <tal:if condition="view.listenerStarted() or request.params.get('debug')">
        Event: 
        <select name="event">
            <tal:for repeat="event view.allEvents()">
            <option value="${event.name}">${event.name}</option>
            </tal:for>
        </select>
        &nbsp;
        Race: 
        <select name="race">
            <option value=""></option>
            <tal:for repeat="race view.allRacesFor()">
            <option value="${race}">${race}</option>
            </tal:for>
        </select>
        <br/><br/>
        <fieldset>
            <legend>Handling</legend>
        <input type="submit" name="listener-event-refresh" value="(Re) load event data"/>&nbsp;
        <input type="submit" name="disconnect-server" value="Disconnect your session"/>&nbsp;&nbsp;&nbsp;

        <input type="submit" name="listener-stop" value="Stop Server" style="background-color: #cc3300;"/>

        </fieldset>
        <br/>
        <fieldset>
            <legend>Leaderboard</legend>
        <input type="submit" name="leaderboard-default-event" style="background-color: green; color: white;" value="Set event as Leaderboard default"/>&nbsp;
        Leaderboard-Default: ${view.currentLeaderboardEvent() and view.currentLeaderboardEvent().name or 'N/A'}&nbsp;
        <a target="_blank" href="${request.application_url}/@@/leaderboard-live">&raquo;&nbsp;Show Leaderboard</a>
        <br/>

        </fieldset>

        <br/>
        <fieldset>
            <legend>Averaging</legend>
            <div>
                Current Averaging: <span id="averaging">...</span>
            </div>
            <div class="field">
                <span>Set averaging interval (in millis) for</span><br/>
                Speed: <input type="text" name="averagingSpeed" value="20000"/>&nbsp;Wind: <input type="text" name="averagingWind" value="20000"/>
            </div>

            <input type="button" value="Load Averaging (needs unpaused listener for the selected race)" onclick="GET('showAveraging', {eventname: $('select[name=event] option:selected').val(), racename: $('select[name=race] option:selected').val()}, function(data) {$('#averaging').html(data)});"/>&nbsp;&nbsp;
            <input type="submit" name="set-averaging" value="Set Averaging (for selected race)"/>
        </fieldset>

    </tal:if>
</form>
