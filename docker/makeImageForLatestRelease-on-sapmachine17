#!/bin/bash
release=$1
if [ "${release}" = "" ]; then
  SET_LATEST=1
  release=$(wget -O - http://releases.sapsailing.com/ 2>/dev/null | grep 'sapmachine17-[0-9]\{10\}' | tail -1 | sed -e 's/^.*\(sapmachine17-[0-9]*\).*$/\1/')
  echo Latest release is ${release}
fi
GITROOT="`dirname $0`/.."
DOCKERDIR="${GITROOT}/docker"
DOCKERFILE="$DOCKERDIR/Dockerfile"
FILES_TO_COPY_FROM_JAVA_TARGET="env.sh start configuration/JavaSE-11.profile"
echo "Copying files from GITROOT $GITROOT into Docker workspace"
for f in ${FILES_TO_COPY_FROM_JAVA_TARGET}; do
  cp "${GITROOT}/java/target/${f}" "$DOCKERDIR"
done
cd "$DOCKERDIR"
docker build --build-arg RELEASE=${release} -t ghcr.io/sap/sailing-analytics:${release} -f Dockerfile_sapsailing_on_sapmachine17 .
echo "Cleaning up..."
for f in ${FILES_TO_COPY_FROM_JAVA_TARGET}; do
  rm "`basename ${f}`"
done
docker push ghcr.io/sap/sailing-analytics:${release}
if [ "$SET_LATEST" = "1" ]; then
  docker tag ghcr.io/sap/sailing-analytics:${release} ghcr.io/sap/sailing-analytics:latest-17
  docker push ghcr.io/sap/sailing-analytics:latest-17
fi
