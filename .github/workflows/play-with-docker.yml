name: play-with-docker
on:
  workflow_dispatch:
    inputs:
      release:
        description: Release
        default: ''
jobs:
  play-with-docker-job:
    #runs-on: ubuntu-latest-64cpu
    #runs-on: ubuntu-latest-4cpu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to docker.sapsailing.com for sapjvm8 image download
        uses: docker/login-action@v3
        with:
          registry: docker.sapsailing.com
          username: ${{ secrets.DOCKER_SAPSAILING_COM_USERNAME }}
          password: ${{ secrets.DOCKER_SAPSAILING_COM_PASSWORD }}
      - name: Login to ghcr.io to upload sailing-analytics image
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Copy a few files
        shell: bash
        run: |
          cp "java/target/env.sh" docker/
          cp "java/target/start" docker/
          cp "java/target/configuration/JavaSE-11.profile" docker/
      - name: Determine release
        shell: bash
        run: |
          echo "RELEASE=$( if [ "${{ github.event.inputs.release }}" = "" ]; then
            wget -O - https://releases.sapsailing.com/ 2>/dev/null | grep 'build-[0-9]\{10\}' | tail -1 | sed -e 's/^.*\(build-[0-9]*\).*$/\1/'
          else
            echo "${{ github.event.inputs.release }}"
          fi )" >>${GITHUB_ENV}
      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          build-args: RELEASE=${{ env.RELEASE }}
          #tags: docker.sapsailing.com/test:${{ env.RELEASE }}
          tags: ghcr.io/sap/sailing-analytics:${{ env.RELEASE }}
          file: docker/Dockerfile
          context: docker/
          push: true
      - name: Clean up copied files
        shell: bash
        run: rm docker/start docker/env.sh docker/JavaSE-11.profile
          
