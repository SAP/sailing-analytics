# Default - NEVER move this or change anything here unless you know what you're doing
# This first VirtualHost catches all port 80 HTTP traffic that is not caught by
# any explicitly matching VirtualHost for port 80 declared further down below.
# It redirects to the URI used, replacing https for http
<VirtualHost *:80>
        AllowEncodedSlashes NoDecode
	ServerName somenonexistingsubdomainname.sapsailing.com
#	New approach: a single RewriteRule that catches all HTTP requests, mapping them to corresponding HTTPS requests
	RewriteEngine on
	RewriteCond %{HTTP:X-Forwarded-Proto} !https
	RewriteCond %{HTTPS} off
	RewriteRule ^.*$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]
	CustomLog logs/redirect_log sapsailing_httpd_redirect_combined env=!original_client_ip
	CustomLog logs/redirect_log sapsailing_httpd_redirect_combined_first_forwarded_for_ip env=original_client_ip
</VirtualHost>

# The explicit rewrite from http://sapsailing.com with missing subdomain name to https://www.sapsailing.com:
<VirtualHost *:80>
	ServerName sapsailing.com
#	New approach: a single RewriteRule that catches all HTTP requests, mapping them to corresponding HTTPS requests
	RewriteEngine on
	RewriteCond %{HTTP:X-Forwarded-Proto} !https
	RewriteCond %{HTTPS} off
	RewriteRule ^.*$ https://www.sapsailing.com%{REQUEST_URI} [L,R=301,NE]
	CustomLog logs/access_log sapsailing_httpd_redirect_combined env=!original_client_ip
	CustomLog logs/access_log sapsailing_httpd_redirect_combined_first_forwarded_for_ip env=original_client_ip
#	Old approach: RedirectPermanent for each :80 VirtualHost
#	RedirectPermanent / https://www.sapsailing.com/	
</VirtualHost>

# WWW as the default virtual host for HTTPS access to port 443 because it's listed as the first on :443
Use Home-ARCHIVE-SSL-Redirect www.sapsailing.com

<VirtualHost *:443>
# a rewrite rule to map sapsailing.com to www.sapsailing.com for HTTPS requests
	ServerName sapsailing.com
	Use SSL
	RewriteEngine on
	RewriteRule ^.*$ https://www.sapsailing.com%{REQUEST_URI} [L,R=301,NE]
	CustomLog logs/access_log sapsailing_httpd_redirect_combined env=!original_client_ip
	CustomLog logs/access_log sapsailing_httpd_redirect_combined_first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:443>
	ServerName jobs.sapsailing.com
	Use SSL
	CustomLog logs/jobs_log combined env=!original_client_ip
	CustomLog logs/jobs_log first_forwarded_for_ip env=original_client_ip
	DocumentRoot /home/trac/static/jobs
	<Directory /home/trac/static/jobs>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride All
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

<VirtualHost *:80>
        ServerName kw2013.sapsailing.com
        RedirectPermanent / http://livecenter.kieler-woche.de/en/
</VirtualHost>

# sail-insight.com
<VirtualHost *:443>
	ServerName sail-insight.com
	ServerAlias www.sail-insight.com
	Use SSL-sail-insight
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	Alias / /home/trac/sail-insight-website/
	<Directory /home/trac/sail-insight-website>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride All
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

# P2 repository
<VirtualHost *:443>
	ServerName p2.sapsailing.com
	Use SSL
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	Alias /p2 /home/trac/p2-repositories
	<Directory /home/trac/p2-repositories>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride None
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

# Git Viewer -->
<VirtualHost *:80>
	ServerName gitlist.sapsailing.com
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	DocumentRoot /var/www/gitlist
	AddHandler php5-script .php
	AddType text/html .php
	DirectoryIndex index.php
	<Directory /var/www/gitlist>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride All
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

# Maven Repositories -->
<VirtualHost *:443>
	ServerName maven.sapsailing.com
	Use SSL
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	Alias /maven /home/trac/maven-repositories
	<Directory /home/trac/maven-repositories>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride None
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

<VirtualHost *:443>
	ServerName bugzilla.sapsailing.com
	Use SSL
	RewriteEngine On
	RewriteRule ^/?$ https://bugzilla.sapsailing.com/bugzilla [L]
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	Alias /bugzilla /usr/share/bugzilla
	<Directory /usr/share/bugzilla>
	  AddHandler cgi-script .cgi
	  Options +Indexes +ExecCGI +FollowSymLinks
	  DirectoryIndex index.cgi
	  AllowOverride Limit Options FileInfo Indexes AuthConfig
	</Directory>
        # Additional Perl modules
	<IfModule mod_env.c>
	    SetEnv PERL5LIB /root/perl5/lib/perl5:/root/perl5/lib/perl5/x86_64-linux-thread-multi
	</IfModule>
</VirtualHost>

# Error pages -->
<VirtualHost *:443>
	ServerName status.sapsailing.com
	Use SSL
	DocumentRoot /var/www/errorpages

	<Directory /var/www/errorpages >
	    Options Indexes FollowSymLinks MultiViews
	    DirectoryIndex index.html
	    AllowOverride None
	    Order allow,deny
	    Allow from all
	</Directory>

	<Location /internal-server-status>
	    SetHandler server-status
	    Order deny,allow
	    Deny from all
	    Allow from all
	    #Allow from 46.142.162.18 localhost 127.0.0.1 *
	</Location>

	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

# PIWIK analytics -->
<VirtualHost *:80>
	ServerName analysis.sapsailing.com
	Alias / /var/www/piwik/
	<Directory /var/www/piwik/ >
	    Options Indexes FollowSymLinks MultiViews
	    DirectoryIndex index.php
	    AllowOverride None
	    Order allow,deny
	    allow from all
	</Directory>
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

# Wiki -->
<VirtualHost *:443>
	ServerName wiki.sapsailing.com
	Use SSL
	RewriteEngine on
	RewriteRule ^/(.*) http://localhost:4567/$1 [P,L]
	ProxyPassReverse / http://localhost:4567/
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:80>
	ServerName stg.static.sapsailing.com
	RedirectPermanent / http://static.sapsailing.com/
</VirtualHost>

<VirtualHost *:80>
	ServerName releases.sapsailing.com
	DocumentRoot /home/trac/releases

	  <Directory /home/trac/releases>
	    Options +Indexes +FollowSymLinks
	  </Directory>
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:443>
	ServerName static.sapsailing.com
	Use SSL
	DocumentRoot /var/www/static

	  <Directory /var/www/static>
	    Order Deny,Allow
	    Allow from all
	    Options -Indexes +FollowSymLinks -ExecCGI
	    AllowOverride All
	  </Directory>
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:80>
  ServerName dev.sapsailing.com
  RedirectPermanent / https://dev.sapsailing.com/	
</VirtualHost>

<VirtualHost *:80>
  ServerName hudson.sapsailing.com
  RedirectPermanent / https://hudson.sapsailing.com/	
</VirtualHost>

<VirtualHost *:443>
  ServerName hudson.sapsailing.com
  Use SSL
  RewriteEngine on
  RewriteRule ^/(.*) http://172.31.28.17:8080/$1 [P,L]
  ProxyPassReverse / http://172.31.28.17:8080/
  CustomLog logs/services_log combined env=!original_client_ip
  CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:80>
  ServerName jenkins.sapsailing.com
  RedirectPermanent / https://jenkins.sapsailing.com/	
</VirtualHost>

<VirtualHost *:443>
  ServerName jenkins.sapsailing.com
  Use SSL
  RewriteEngine on
  RewriteRule ^/(.*) http://172.31.17.141:8080/$1 [P,L]
  ProxyPassReverse / http://172.31.17.141:8080/
  CustomLog logs/services_log combined env=!original_client_ip
  CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

