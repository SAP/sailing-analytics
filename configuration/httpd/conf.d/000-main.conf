# Default - NEVER move this or change anything here unless you know what you're doing
# This first VirtualHost catches all port 80 HTTP traffic that is not caught by
# any explicitly matching VirtualHost for port 80 declared further down below.
# It redirects to www.sapsailing.com
<VirtualHost *:80>
        AllowEncodedSlashes NoDecode
	ServerName somenonexistingsubdomainname.sapsailing.com
#	New approach: a single RewriteRule that catches all HTTP requests, mapping them to corresponding HTTPS requests
	RewriteEngine on
	RewriteRule ^.*$ https://www.sapsailing.com%{REQUEST_URI} [L,R=302,NE]
	CustomLog logs/redirect_log sapsailing_httpd_redirect_combined env=!original_client_ip
	CustomLog logs/redirect_log sapsailing_httpd_redirect_combined_first_forwarded_for_ip env=original_client_ip
</VirtualHost>

# The explicit rewrite from http://sapsailing.com with missing subdomain name to https://www.sapsailing.com:
# COMMENTED; first for a test with 505worlds2010.sapsailing.com; if this works, continue down this path:
<VirtualHost *:80>
	ServerName sapsailing.com
#	New approach: a single RewriteRule that catches all HTTP requests, mapping them to corresponding HTTPS requests
	RewriteEngine on
#        LogLevel alert rewrite:trace5
        # The .well-known/assetlinks.json file needs to be returned straight without an external redirect:
	RewriteCond %{REQUEST_METHOD} GET
        RewriteCond %{REQUEST_URI} /.well-known/assetlinks.json
	RewriteRule ^.*$ http://${ARCHIVE_IP}:8888%{REQUEST_URI} [P]

	RewriteCond %{HTTP:X-Forwarded-Proto} !https
	RewriteCond %{HTTPS} off
	RewriteRule ^.*$ https://www.sapsailing.com%{REQUEST_URI} [L,R=301,NE]
	CustomLog logs/access_log sapsailing_httpd_redirect_combined env=!original_client_ip
	CustomLog logs/access_log sapsailing_httpd_redirect_combined_first_forwarded_for_ip env=original_client_ip
</VirtualHost>

# WWW as the default virtual host for HTTPS access to port 443 because it's listed as the first on :443
Use Home-ARCHIVE www.sapsailing.com

<VirtualHost *:443>
# a rewrite rule to map sapsailing.com to www.sapsailing.com for HTTPS requests
	ServerName sapsailing.com
	Use SSL
	RewriteEngine on
	RewriteRule ^.*$ https://www.sapsailing.com%{REQUEST_URI} [L,R=301,NE]
	CustomLog logs/access_log sapsailing_httpd_redirect_combined env=!original_client_ip
	CustomLog logs/access_log sapsailing_httpd_redirect_combined_first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:80>
	ServerName jobs.sapsailing.com
	CustomLog logs/jobs_log combined env=!original_client_ip
	CustomLog logs/jobs_log first_forwarded_for_ip env=original_client_ip
	DocumentRoot /home/trac/static/jobs
	<Directory /home/trac/static/jobs>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride All
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

# sail-insight.com
<VirtualHost *:80>
	ServerName sail-insight.com
	ServerAlias www.sail-insight.com
	RedirectPermanent / https://sail-insight.com/
</VirtualHost>
<VirtualHost *:443>
	ServerName sail-insight.com
	ServerAlias www.sail-insight.com
	Use SSL-sail-insight
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	Alias / /home/trac/sail-insight-website/
	<Directory /home/trac/sail-insight-website>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride All
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

# P2 repository
<VirtualHost *:80>
	ServerName p2.sapsailing.com
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	Alias /p2 /home/trac/p2-repositories
	<Directory /home/trac/p2-repositories>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride None
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

# Git Viewer -->
<VirtualHost *:80>
	ServerName gitlist.sapsailing.com
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	DocumentRoot /var/www/gitlist
	AddHandler php5-script .php
	AddType text/html .php
	DirectoryIndex index.php
	<Directory /var/www/gitlist>
	    Options Indexes FollowSymLinks MultiViews
	    AllowOverride All
	    Order allow,deny
	    allow from all
	</Directory>
</VirtualHost>

<VirtualHost *:80>
	ServerName bugzilla.sapsailing.com
	RewriteEngine On
	RewriteRule ^/?$ http://bugzilla.sapsailing.com/bugzilla [L]
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
	Alias /bugzilla /usr/share/bugzilla
	<Directory /usr/share/bugzilla>
	  AddHandler cgi-script .cgi
	  Options +Indexes +ExecCGI +FollowSymLinks
	  DirectoryIndex index.cgi
	  AllowOverride Limit Options FileInfo Indexes AuthConfig
	</Directory>
        # Additional Perl modules
	<IfModule mod_env.c>
	    SetEnv PERL5LIB /root/perl5/lib/perl5:/root/perl5/lib/perl5/x86_64-linux-thread-multi
	</IfModule>
</VirtualHost>

# Wiki -->
<VirtualHost *:80>
	ServerName wiki.sapsailing.com
	RewriteEngine on
	RewriteRule ^/(.*) http://localhost:4567/$1 [P,L]
	ProxyPassReverse / http://localhost:4567/
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:80>
	ServerName releases.sapsailing.com
	DocumentRoot /home/trac/releases
	  <Directory /home/trac/releases>
	    Options +Indexes +FollowSymLinks
	  </Directory>
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:80>
	ServerName static.sapsailing.com
	DocumentRoot /var/www/static
	  <Directory /var/www/static>
	    Order Deny,Allow
	    Allow from all
	    Options -Indexes +FollowSymLinks -ExecCGI
	    AllowOverride All
	  </Directory>
	CustomLog logs/services_log combined env=!original_client_ip
	CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>

<VirtualHost *:80>
  ServerName hudson.sapsailing.com
  RewriteEngine on
#  LogLevel alert rewrite:trace5
  RewriteRule ^/(.*)$ http://172.31.28.12:8080/$1 [P]
  ProxyPassReverse / http://172.31.28.12:8080/
  CustomLog logs/services_log combined env=!original_client_ip
  CustomLog logs/services_log first_forwarded_for_ip env=original_client_ip
</VirtualHost>
