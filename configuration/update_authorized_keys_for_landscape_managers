#!/bin/bash
BEARER_TOKEN="$1"
BASE_URL="$2"
LOGON_USER_HOME="$3"
SSH_DIR="$3/.ssh"
#
users=$( curl -H 'X-SAPSSE-Forward-Request-To: master' -H 'Authorization: Bearer '${BEARER_TOKEN} "${BASE_URL}/security/api/restsecurity/users_with_permission?permission=LANDSCAPE:MANAGE:AWS" 2>/dev/null | jq -r '.[]' )
logger -t sailing "Users with LANDSCAPE:MANAGE:AWS permission: ${users}"
public_keys=$( for user in ${users}; do
  curl -H 'X-SAPSSE-Forward-Request-To: master' -H 'Authorization: Bearer '${BEARER_TOKEN} "${BASE_URL}/landscape/api/landscape/get_ssh_keys_owned_by_user?username[]=${user}" 2>/dev/null | jq -r '.[].publicKey'
done | sort -u )
logger -t sailing "Obtained public keys: ${public_keys}"
if [ ! -f ${SSH_DIR}/authorized_keys.org ]; then
  # Create a copy of the original authorized_keys file as generated by AWS from the start-up key:
  logger -t sailing "Saving original authorized_keys file from ${SSH_DIR}"
  cp ${SSH_DIR}/authorized_keys ${SSH_DIR}/authorized_keys.org
fi
# Start out with the original AWS-generated authorized_keys file
# and append the public SSH keys of all users having LANDSCAPE:MANAGE:AWS permission:
echo "$( cat ${SSH_DIR}/authorized_keys.org )
${public_keys}" | sort -u >${SSH_DIR}/authorized_keys
