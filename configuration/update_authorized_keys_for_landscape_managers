#!/bin/bash
BEARER_TOKEN="$1"
BASE_URL="https://security-service.sapsailing.com"
SSH_DIR=~root/.ssh
#
public_keys=$( for user in `curl -H 'Authorization: Bearer '${BEARER_TOKEN} "${BASE_URL}/security/api/restsecurity/users_with_permission?permission=LANDSCAPE:MANAGE:AWS" 2>/dev/null | jq -r '.[]'`; do
  curl -H 'Authorization: Bearer '${BEARER_TOKEN} "${BASE_URL}/landscape/api/landscape/get_ssh_keys_owned_by_user?username[]=${user}" 2>/dev/null | jq -r '.[].publicKey'
done | sort -u )
if [ ! -f /root/.ssh/authorized_keys.org ]; then
  # Create a copy of the original authorized_keys file as generated by AWS from the start-up key:
  cp ${SSH_DIR}/authorized_keys ${SSH_DIR}/authorized_keys.org
fi
# Start out with the original AWS-generated authorized_keys file
cp ${SSH_DIR}/authorized_keys.org ${SSH_DIR}/authorized_keys
# Now append the public SSH keys of all users having LANDSCAPE:MANAGE:AWS permission:
echo "${public_keys}" >>${SSH_DIR}/authorized_keys
