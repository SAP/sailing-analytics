#!/bin/bash
PREFIX=$1
shift
for i in $*; do
  if [ ${i: -3} == ".gz" ]; then
    gzip -cd $i
  else
    cat $i
  fi | iconv -f ISO-8859-1 -t UTF8 |
       sed -e 's/^\([^T]*\)T\([^.]*\)[^ ]* [^ ]* \([^:]*\):[^ ]* [^ ]* [^ ]* [^ ]* [^ ]* [^ ]* \([^ ]*\) \([^ ]*\) [^ ]* \(\"[^"]*\"\) \(\"[^"]*\"\).*$/'$PREFIX' \3 - - [\1:\2 +0000] \6 \4 \5 "http:\/\/'$PREFIX'" \7/' |
       sed -e 's/\[\([0-9]*\)-01-\([0-9]*\):/\[\2\/Jan\/\1:/' |
       sed -e 's/\[\([0-9]*\)-02-\([0-9]*\):/\[\2\/Feb\/\1:/' |
       sed -e 's/\[\([0-9]*\)-03-\([0-9]*\):/\[\2\/Mar\/\1:/' |
       sed -e 's/\[\([0-9]*\)-04-\([0-9]*\):/\[\2\/Apr\/\1:/' |
       sed -e 's/\[\([0-9]*\)-05-\([0-9]*\):/\[\2\/May\/\1:/' |
       sed -e 's/\[\([0-9]*\)-06-\([0-9]*\):/\[\2\/Jun\/\1:/' |
       sed -e 's/\[\([0-9]*\)-07-\([0-9]*\):/\[\2\/Jul\/\1:/' |
       sed -e 's/\[\([0-9]*\)-08-\([0-9]*\):/\[\2\/Aug\/\1:/' |
       sed -e 's/\[\([0-9]*\)-09-\([0-9]*\):/\[\2\/Sep\/\1:/' |
       sed -e 's/\[\([0-9]*\)-10-\([0-9]*\):/\[\2\/Oct\/\1:/' |
       sed -e 's/\[\([0-9]*\)-11-\([0-9]*\):/\[\2\/Nov\/\1:/' |
       sed -e 's/\[\([0-9]*\)-12-\([0-9]*\):/\[\2\/Dec\/\1:/'
done
