#!/bin/bash
eval $( ec2-metadata -d | sed -e 's/^user-data: //' )
if [ -n "$REPLICA_SET_PRIMARY" ]; then
  IP=$(ec2-metadata -o | sed -e 's/^local-ipv4: //')
  PRIMARY_IP=$(echo "rs.isMaster().primary" | mongo --quiet "mongodb://$IP" | grep -o "^[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+")
  if [[ "$IP" == "$PRIMARY_IP" ]]; then
    echo "rs.stepDown()" | mongo "mongodb://$PRIMARY_IP"
    sleep 10
  fi
  echo "rs.remove(\"$IP:27017\")" | mongo "mongodb://$IP/?replicaSet=$REPLICA_SET_NAME&retryWrites=true"
fi
