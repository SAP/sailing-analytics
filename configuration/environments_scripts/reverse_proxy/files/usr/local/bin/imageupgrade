#!/bin/bash

# Script to deploy on an instance that has an ephemeral volume as /dev/nvme0n1 (adjust env var PARTITION if different)
# Ensures the partition is xfs-formatted, any existing partition contents will be overwritten if formatted otherwise.
# An existing xfs partition will be left alone.
. imageupgrade_functions.sh

get_ec2_user_data() {
  /bin/ec2-metadata -d | sed -e 's/^user-data: //'
}

METADATA=$( get_ec2_user_data )
echo "Metadata: ${METADATA}"
if echo "${METADATA}" | grep -q "^image-upgrade$"; then
  echo "Image upgrade..."
  GIT_USER="trac"
  RELATIVE_PATH_TO_GIT="gitcopy"
  BUILD_TYPE="reverse_proxy"
  LOGON_USER_HOME="ec2-user"
  run_yum_update
  build_crontab
  finalize
fi

