#!/bin/bash

# Purpose: This script iterates over an environments' USER folders, concatenating all the symbolic
# links (referencing locations within configuration/crontabs) into one file for each user. It takes the git home dir
# as well as the name of the dir within the home user. The created files for each user go into that user's 
# home dir and are installed for that user too. 
# Useful files are also copied across.

if [[ $# -ne 3 && $# -ne 4 ]]; then
    echo "$0 <ENVIRONMENT_TYPE> <USER_WITH_CODE> <NAME_OF_GIT_DIR>  "
    echo ""
    echo "Where USER_WITH_CODE is a user that contains a checked out copy of the main git."
    echo "And where NAME_OF_GIT_DIR is the path to the git repo from the USER_WITH_CODE's home directory."
    echo "Use the s flag to only do the crontab and not copy any files across"
    exit 2
fi

options='s'
while getopts $options option
do
    case $option in
        s) ONLY_CRONTAB="true";;
        \?) echo "Invalid option"
            exit 4;;
    esac
done
shift $((OPTIND-1)) # shift the arguments along so -s is no longer $1
ENV_TYPE="$1"
GIT_USER="$2"
GIT_DIR_NAME="$3"
cd "$(dirname "$0")/${ENV_TYPE}/users"
GIT_PATH="$(grep "^${GIT_USER}" /etc/passwd | cut -d':' -f6)/${GIT_DIR_NAME}" # The path to the git repo that contains the files needed.
for dir in $(ls -d */ ); do
    USERNAME=$(echo $dir | sed "s/\/$//") # Dirname is the username. The trailing slash is removed.
    HOME_DIR=$(grep "^${USERNAME}" /etc/passwd | cut -d':' -f6)   # The path to the home dir of the user whose cronjob will be installed.
    > $HOME_DIR/crontab
    for crontab in $(ls ${USERNAME}/crontab*); do
        cat "$crontab"  >> $HOME_DIR/crontab
        echo "" >> $HOME_DIR/crontab  # Adds a newline
    done
    if [[ -d "${dir}baseHomeDir" ]]; then
        cp -r ${dir}baseHomeDir/* $HOME_DIR
    fi
    sed -i "s|PATH_OF_GIT_HOME_DIR_TO_REPLACE|${GIT_PATH}|g" $HOME_DIR/crontab # Sets correct path to the git repo within the crontab.
    sed -i "s|PATH_OF_HOME_DIR_TO_REPLACE|${HOME_DIR}|g" $HOME_DIR/crontab # Sets the correct path to the home dir of the user whose crontab will be installed.
    crontab -u ${USERNAME} $HOME_DIR/crontab # Install the crontab in the given user's home dir.
done

if [[ "$ONLY_CRONTAB" != "true" ]]; then
    cd ../files
    \cp -rL * /   # copies all files accross, realising any symbolic links. The backslash escapes the alias cp -i.
fi
